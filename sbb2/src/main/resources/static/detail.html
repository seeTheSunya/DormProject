<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>ê¸€ ìƒì„¸</title>
    <style>
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        <!-- í—¤ë” (ê¸°ì¡´ ë™ì¼) -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="container mx-auto px-6 py-4 flex items-center justify-between">
                <a href="main.html" class="text-2xl font-bold text-gray-800 hover:text-blue-600 transition">ğŸ  ë„ë€</a>
                <div v-if="loggedInUser" class="flex items-center space-x-3">
                    <span class="text-gray-600"><b>{{ loggedInUser }}</b>ë‹˜</span>
                    <button @click="logout" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded hover:bg-gray-300 transition">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-6 pb-12">
            <!-- ë¡œê·¸ì¸ ì•ˆ í•¨ -->
            <div v-if="!loggedInUser">
                <div class="bg-white p-10 rounded-xl shadow-md max-w-lg w-full mx-auto mt-10 text-center animate-fade-in-up">
                    <div class="text-6xl mb-4">ğŸ”’</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</h2>
                    <a href="login.html" class="w-full inline-block bg-blue-600 text-white text-lg font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-lg mt-4">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a>
                </div>
            </div>

            <!-- ìƒì„¸ ë‚´ìš© -->
            <div v-if="loggedInUser && post" class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden animate-fade-in-up mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h1 class="text-3xl font-bold text-gray-900 mb-3">{{ post.title }}</h1>
                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                        <span>ì‘ì„±ì: <b class="text-gray-700">{{ post.member ? post.member.username : 'ìµëª…' }}</b></span>
                        <span>|</span>
                        <span>ì‘ì„±ì¼: {{ formatDate(post.createdAt) }}</span>
                    </div>
                </div>
                <div class="p-6 min-h-[200px]">
                    <pre class="text-base text-gray-800 whitespace-pre-wrap font-sans">{{ post.content }}</pre>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-between">
                    <a :href="'board.html?category=' + post.category" class="bg-gray-200 text-gray-700 font-semibold px-5 py-2 rounded-lg hover:bg-gray-300 transition">ëª©ë¡ìœ¼ë¡œ</a>
                </div>
            </div>

            <!-- â˜…â˜…â˜… ëŒ“ê¸€ ì˜ì—­ â˜…â˜…â˜… -->
            <div v-if="loggedInUser && post" class="bg-white rounded-lg shadow-md border border-gray-200 p-6 animate-fade-in-up">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ëŒ“ê¸€ ({{ comments.length }})</h3>
                
                <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                <div class="flex space-x-2 mb-6">
                    <input v-model="newComment" @keyup.enter="addComment(null)" type="text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button @click="addComment(null)" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">ë“±ë¡</button>
                </div>

                <!-- ëŒ“ê¸€ ëª©ë¡ (ì¬ê·€ ì»´í¬ë„ŒíŠ¸ ì‚¬ìš©) -->
                <ul class="space-y-4">
                    <comment-item v-for="comment in comments" :key="comment.id" :comment="comment" @reply="handleReply"></comment-item>
                </ul>
            </div>

        </main>
    </div>

    <script>
        const { createApp } = Vue;

        // â˜… ì¬ê·€ ëŒ“ê¸€ ì»´í¬ë„ŒíŠ¸ (ëŒ€ëŒ“ê¸€ í‘œì‹œìš©)
        const CommentItem = {
            props: ['comment'],
            data() { return { showReplyForm: false, replyContent: '' }; },
            template: `
                <li class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-bold text-gray-700 mr-2">{{ comment.authorName }}</span>
                            <span class="text-xs text-gray-400">{{ formatDate(comment.createdAt) }}</span>
                            <p class="mt-1 text-gray-800">{{ comment.content }}</p>
                        </div>
                        <button @click="showReplyForm = !showReplyForm" class="text-sm text-blue-500 hover:underline">ë‹µê¸€</button>
                    </div>

                    <!-- ë‹µê¸€ ì‘ì„± í¼ -->
                    <div v-if="showReplyForm" class="mt-3 flex space-x-2 ml-4">
                        <input v-model="replyContent" @keyup.enter="submitReply" type="text" placeholder="ë‹µê¸€ ì…ë ¥..." 
                               class="flex-grow p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <button @click="submitReply" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">ë“±ë¡</button>
                    </div>

                    <!-- â˜… ìì‹ ëŒ“ê¸€ (ëŒ€ëŒ“ê¸€) ì¬ê·€ ë Œë”ë§ -->
                    <ul v-if="comment.children && comment.children.length > 0" class="mt-3 ml-6 space-y-3 border-l-2 border-gray-200 pl-3">
                        <comment-item v-for="child in comment.children" :key="child.id" :comment="child" @reply="$emit('reply', $event)"></comment-item>
                    </ul>
                </li>
            `,
            methods: {
                formatDate(dateString) {
                    if (!dateString) return '';
                    return new Date(dateString).toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                },
                submitReply() {
                    if(!this.replyContent.trim()) return;
                    this.$emit('reply', { parentId: this.comment.id, content: this.replyContent });
                    this.replyContent = '';
                    this.showReplyForm = false;
                }
            }
        };

        const app = createApp({
            data() {
                return {
                    loggedInUser: localStorage.getItem('loggedInUser') || null,
                    post: null,
                    comments: [], // ëŒ“ê¸€ ëª©ë¡
                    postId: null,
                    newComment: '' // ìƒˆ ëŒ“ê¸€ ë‚´ìš©
                }
            },
            mounted() {
                const params = new URLSearchParams(window.location.search);
                this.postId = params.get('id');
                if (this.loggedInUser && this.postId) {
                    this.fetchPostDetail();
                    this.fetchComments();
                }
            },
            methods: {
                // ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ
                async fetchPostDetail() {
                    try {
                        const response = await axios.get(`http://localhost:8080/api/posts/${this.postId}`);
                        this.post = response.data;
                    } catch (e) { console.error(e); }
                },
                // â˜… ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ
                async fetchComments() {
                    try {
                        const response = await axios.get(`http://localhost:8080/api/comments/${this.postId}`);
                        this.comments = response.data;
                    } catch (e) { console.error(e); }
                },
                // â˜… ëŒ“ê¸€ ë“±ë¡ (ë¶€ëª¨ IDê°€ ìˆìœ¼ë©´ ë‹µê¸€, ì—†ìœ¼ë©´ ìƒˆ ëŒ“ê¸€)
                async addComment(parentId, content = null) {
                    const text = content || this.newComment;
                    if (!text.trim()) { alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }

                    try {
                        await axios.post(`http://localhost:8080/api/comments/${this.postId}`, {
                            content: text,
                            username: this.loggedInUser,
                            parentId: parentId
                        });
                        this.newComment = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
                        await this.fetchComments(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } catch (e) {
                        alert("ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨");
                    }
                },
                // ë‹µê¸€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                handleReply(payload) {
                    this.addComment(payload.parentId, payload.content);
                },
                logout() {
                    localStorage.removeItem('loggedInUser');
                    window.location.href = 'main.html';
                },
                formatDate(date) {
                    return new Date(date).toLocaleString();
                }
            }
        });
        
        app.component('comment-item', CommentItem);
        app.mount('#app');
    </script>
</body>
</html>