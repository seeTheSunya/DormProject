<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Vue.js, Tailwind, Axios -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- â˜… ìˆ˜ì • 1: ê¸€ ë³¼ ë•Œë„ ì—ë””í„°ì™€ ë˜‘ê°™ì€ ë””ìì¸ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ Quill CSS ì¶”ê°€ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <title>ê¸€ ìƒì„¸</title>
    <style>
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ìƒì„¸ í˜ì´ì§€ì—ì„œ ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í¬ë©´ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ” ê²ƒ ë°©ì§€ */
        .ql-editor img {
            max-width: 100%;
            height: auto;
        }
        /* ë³´ê¸° ì „ìš©ì´ë¯€ë¡œ í…Œë‘ë¦¬ ì œê±° ë° íŒ¨ë”© ì¡°ì • */
        .ql-container.ql-snow { border: none; }
        .ql-editor { padding: 0; font-family: inherit; font-size: 16px; }
        
        /* â˜…â˜…â˜… í…Œë§ˆë³„ ìƒ‰ìƒ ì •ì˜ â˜…â˜…â˜… */
        body.theme-light { background-color: #f3f4f6; color: #1f2937; }
        body.theme-dark { background-color: #111827; color: #e5e7eb; }
        body.theme-dark .bg-white { background-color: #1f2937 !important; border-color: #374151; color: #e5e7eb; }
        body.theme-dark .text-gray-800 { color: #f3f4f6 !important; }
        body.theme-dark .text-gray-600 { color: #9ca3af !important; }
        body.theme-dark header { background-color: #1f2937 !important; border-bottom: 1px solid #374151; }
        body.theme-blue { background-color: #f7faf9; color: #5a7a72; }
        body.theme-blue header { background-color: #eaf5f2 !important; }
        body.theme-pink { background-color: #fef5f0; color: #b85d4a; }
        body.theme-pink header { background-color: #fce8df !important; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="container mx-auto px-6 py-4 flex items-center justify-between">
                <a href="main.html" class="text-2xl font-bold text-gray-800 hover:text-blue-600 transition">ğŸ  ë„ë€</a>
                <div v-if="loggedInUser" class="flex items-center space-x-3">
                    <span class="text-gray-600"><b>{{ loggedInUser }}</b>ë‹˜</span>
                    <button @click="logout" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded hover:bg-gray-300 transition">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-6 pb-12">
            <!-- 1. ë¡œê·¸ì¸ ì•ˆ í•¨ -->
            <div v-if="!loggedInUser">
                <div class="bg-white p-10 rounded-xl shadow-md max-w-lg w-full mx-auto mt-10 text-center animate-fade-in-up">
                    <div class="text-6xl mb-4">ğŸ”’</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</h2>
                    <a href="login.html" class="w-full inline-block bg-blue-600 text-white text-lg font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-lg mt-4">
                        ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°
                    </a>
                </div>
            </div>

            <!-- 2. ë¡œë”© ì¤‘ -->
            <div v-if="loggedInUser && isLoading" class="text-center py-20">
                <p class="text-gray-500 text-lg">ê¸€ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <!-- 3. ìƒì„¸ ë‚´ìš© (ë¡œë”© ë, ë°ì´í„° ìˆìŒ) -->
            <div v-if="loggedInUser && !isLoading && post" class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden animate-fade-in-up mb-6">
                <div class="p-6 border-b border-gray-200 flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-3">{{ post.title }}</h1>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span>ì‘ì„±ì: <b class="text-gray-700">{{ post.member ? post.member.username : 'ìµëª…' }}</b></span>
                            <span>|</span>
                            <span>ì‘ì„±ì¼: {{ formatDate(post.createdAt) }}</span>
                        </div>
                    </div>
                    
                    <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                    <button @click="toggleLike" 
                            :class="isLiked ? 'bg-red-100 text-red-600 border-red-200' : 'bg-gray-100 text-gray-500 border-gray-200'"
                            class="flex flex-col items-center px-4 py-2 rounded-lg border hover:bg-red-50 transition duration-200 group">
                        <span class="text-2xl group-hover:scale-110 transition transform">{{ isLiked ? 'â¤ï¸' : 'ğŸ¤' }}</span>
                        <span class="text-xs font-bold mt-1">{{ post.likeCount }}</span>
                    </button>
                </div>
                
                <div class="p-6 min-h-[200px]">
                    <!-- â˜… ìˆ˜ì • 2: v-html ì‚¬ìš© ë° Quill í´ë˜ìŠ¤ ì ìš© -->
                    <!-- ê¸°ì¡´: <pre>{{ post.content }}</pre> (ê¸€ìë¡œ ë³´ì„) -->
                    <!-- ë³€ê²½: <div v-html="post.content"> (HTMLë¡œ ë Œë”ë§ë¨ + ì´ë¯¸ì§€ ë³´ì„) -->
                    <div class="ql-container ql-snow">
                        <div class="ql-editor" v-html="post.content"></div>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-between">
                    <a :href="'board.html?category=' + post.category" class="bg-gray-200 text-gray-700 font-semibold px-5 py-2 rounded-lg hover:bg-gray-300 transition">ëª©ë¡ìœ¼ë¡œ</a>
                    <div>
                        <button class="bg-red-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-red-600 transition">ì‚­ì œ</button>
                    </div>
                </div>
            </div>

            <!-- 4. ì—ëŸ¬ ë˜ëŠ” ê¸€ ì—†ìŒ -->
            <div v-if="loggedInUser && !isLoading && !post" class="text-center py-20">
                <p class="text-red-500 text-xl mb-4">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
                <p class="text-gray-500">ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê¸€ì…ë‹ˆë‹¤.</p>
                <a href="main.html" class="text-blue-600 hover:underline mt-4 inline-block">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>

            <!-- ëŒ“ê¸€ ì˜ì—­ -->
            <div v-if="loggedInUser && post" class="bg-white rounded-lg shadow-md border border-gray-200 p-6 animate-fade-in-up">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ëŒ“ê¸€ ({{ comments.length }})</h3>
                
                <div class="flex space-x-2 mb-6">
                    <input v-model="newComment" @keyup.enter="addComment(null)" type="text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button @click="addComment(null)" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">ë“±ë¡</button>
                </div>

                <ul class="space-y-4">
                    <comment-item v-for="comment in comments" :key="comment.id" :comment="comment" @reply="handleReply"></comment-item>
                </ul>
            </div>
        </main>
    </div>

    <script>
        if (typeof Vue === 'undefined') {
            alert("Vue.js ë¡œë“œ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
        }
        const { createApp } = Vue;

        const CommentItem = {
            props: ['comment'],
            data() { return { showReplyForm: false, replyContent: '' }; },
            template: `
                <li class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-bold text-gray-700 mr-2">{{ comment.authorName }}</span>
                            <span class="text-xs text-gray-400">{{ formatDate(comment.createdAt) }}</span>
                            <p class="mt-1 text-gray-800">{{ comment.content }}</p>
                        </div>
                        <button @click="showReplyForm = !showReplyForm" class="text-sm text-blue-500 hover:underline">ë‹µê¸€</button>
                    </div>
                    <div v-if="showReplyForm" class="mt-3 flex space-x-2 ml-4">
                        <input v-model="replyContent" @keyup.enter="submitReply" type="text" placeholder="ë‹µê¸€ ì…ë ¥..." 
                               class="flex-grow p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <button @click="submitReply" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">ë“±ë¡</button>
                    </div>
                    <ul v-if="comment.children && comment.children.length > 0" class="mt-3 ml-6 space-y-3 border-l-2 border-gray-200 pl-3">
                        <comment-item v-for="child in comment.children" :key="child.id" :comment="child" @reply="$emit('reply', $event)"></comment-item>
                    </ul>
                </li>
            `,
            methods: {
                formatDate(dateString) {
                    if (!dateString) return '';
                    return new Date(dateString).toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                },
                submitReply() {
                    if(!this.replyContent.trim()) return;
                    this.$emit('reply', { parentId: this.comment.id, content: this.replyContent });
                    this.replyContent = '';
                    this.showReplyForm = false;
                }
            }
        };

        const app = createApp({
            data() {
                return {
                    loggedInUser: localStorage.getItem('loggedInUser') || null,
                    post: null,
                    comments: [],
                    postId: null,
                    newComment: '',
                    isLiked: false,
                    isLoading: true
                }
            },
            mounted() {
                // â˜…â˜…â˜… í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í…Œë§ˆ ë¶ˆëŸ¬ì˜¤ê¸° â˜…â˜…â˜…
                const savedTheme = localStorage.getItem('userTheme') || 'light';
                document.body.className = `theme-${savedTheme}`;
                
                const params = new URLSearchParams(window.location.search);
                this.postId = params.get('id');
                
                if (this.loggedInUser && this.postId) {
                    this.fetchPostDetail();
                    this.fetchComments();
                } else {
                    this.isLoading = false;
                }
            },
            methods: {
                async fetchPostDetail() {
                    this.isLoading = true;
                    try {
                        const response = await axios.get(`http://localhost:8080/api/posts/${this.postId}?username=${this.loggedInUser}`);
                        if (response.data.post) {
                            this.post = response.data.post; 
                            this.isLiked = response.data.liked;
                        } else {
                            this.post = response.data;
                            this.isLiked = false;
                        }
                    } catch (e) { 
                        this.post = null;
                    } finally {
                        this.isLoading = false;
                    }
                },
                async toggleLike() {
                    try {
                        const response = await axios.post(`http://localhost:8080/api/posts/${this.postId}/like`, {
                            username: this.loggedInUser
                        });
                        this.isLiked = response.data;
                        if (this.isLiked) this.post.likeCount++;
                        else this.post.likeCount--;
                    } catch (e) {
                        this.handleError(e);
                    }
                },
                async fetchComments() {
                    try {
                        const response = await axios.get(`http://localhost:8080/api/comments/${this.postId}`);
                        this.comments = response.data;
                    } catch (e) { console.error(e); }
                },
                async addComment(parentId, content = null) {
                    const text = content || this.newComment;
                    if (!text.trim()) { alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }

                    try {
                        await axios.post(`http://localhost:8080/api/comments/${this.postId}`, {
                            content: text,
                            username: this.loggedInUser,
                            parentId: parentId
                        });
                        this.newComment = '';
                        await this.fetchComments();
                    } catch (e) {
                        this.handleError(e);
                    }
                },
                handleReply(payload) {
                    this.addComment(payload.parentId, payload.content);
                },
                logout() {
                    localStorage.removeItem('loggedInUser');
                    window.location.href = 'main.html';
                },
                formatDate(date) {
                    return new Date(date).toLocaleString();
                },
                handleError(e) {
                    if (e.response && e.response.data) {
                        alert(e.response.data);
                        if (typeof e.response.data === 'string' && (e.response.data.includes("ì‚¬ìš©ì") || e.response.data.includes("ë¡œê·¸ì¸"))) {
                            this.logout();
                        }
                    } else {
                        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                }
            }
        });
        app.component('comment-item', CommentItem);
        app.mount('#app');
    </script>
</body>
</html>