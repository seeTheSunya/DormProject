<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€ - ë„ë€</title>
    <!-- Vue.js (ì „ì—­ ë¹Œë“œ), Tailwind, Axios -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <style>
        /* ë¶€ë“œëŸ¬ìš´ ìƒ‰ìƒ ì „í™˜ íš¨ê³¼ */
        body { transition: background-color 0.3s, color 0.3s; }
        
        /* â˜… í…Œë§ˆë³„ ìƒ‰ìƒ ì •ì˜ â˜… */
        body.theme-light { background-color: #f3f4f6; color: #1f2937; }
        
        body.theme-dark { background-color: #111827; color: #e5e7eb; }
        body.theme-dark .bg-white { background-color: #1f2937 !important; border-color: #374151; color: #e5e7eb; }
        body.theme-dark .bg-blue-50 { background-color: #374151 !important; color: #e5e7eb; }
        body.theme-dark input { background-color: #374151; color: #e5e7eb; border-color: #4b5563; }
        body.theme-dark .text-gray-800 { color: #f3f4f6 !important; }
        body.theme-dark .text-gray-700 { color: #d1d5db !important; }
        body.theme-dark .text-gray-600 { color: #9ca3af !important; }
        body.theme-dark header { background-color: #1f2937 !important; border-bottom: 1px solid #374151; }

        /* ë‹¤í¬ëª¨ë“œ ë²„íŠ¼ ë° ì…€ë ‰íŠ¸ ë°•ìŠ¤ ìƒ‰ìƒ ë³´ì • */
        body.theme-dark select { background-color: #374151 !important; color: #e5e7eb !important; border-color: #4b5563; }
        body.theme-dark .bg-gray-200 { background-color: #374151 !important; color: #e5e7eb !important; border: 1px solid #4b5563; }
        body.theme-dark .bg-gray-200:hover { background-color: #4b5563 !important; }
        
        /* ë‹¤í¬ëª¨ë“œì—ì„œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ìœ ì§€ */
        body.theme-dark button[style*="background-color: #FFF9D9"] { color: #1f2937 !important; }
        body.theme-dark button[style*="background-color: #D66A58"] { color: #ffffff !important; }

        /* 3. ë¸”ë£¨ ëª¨ë“œ */
        body.theme-blue { background-color: #f7faf9; color: #5a7a72; }
        body.theme-blue .bg-white { background-color: #eaf5f2 !important; }
        body.theme-blue header { background-color: #dbeafe !important; }
        
        /* 4. í•‘í¬ ëª¨ë“œ */
        body.theme-pink { background-color: #fef5f0; color: #b85d4a; }
        body.theme-pink .bg-white { background-color: #fce8df !important; }
        body.theme-pink header { background-color: #ffe4e6 !important; }

        /* â˜…â˜…â˜… [ì¶”ê°€] ë²šê½ƒ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ â˜…â˜…â˜… */
        .cherry-blossom {
            position: fixed;
            top: -10px;
            background-color: #FFB7C5; /* ë²šê½ƒìƒ‰ */
            border-radius: 150% 0 150% 0; /* ê½ƒì ëª¨ì–‘ */
            pointer-events: none; /* í´ë¦­ ë°©í•´ ê¸ˆì§€ */
            z-index: 9999;
            opacity: 0.8;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg) translateX(50px);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="bg-white shadow-sm sticky top-0 z-10 transition-colors duration-300">
            <div class="container mx-auto px-6 py-4 flex items-center justify-between">
                <div class="flex items-center cursor-pointer" @click="goToMain" style="margin-left: -60px;">
                    <img src="/assets/doran-logo2.png" alt="ë„ë€ ë¡œê³ " style="height: 49px; object-fit: contain;" onerror="this.style.display='none'; console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', this.src);">
                    <span class="text-xs text-gray-600 ml-2 font-bold" style="font-size: 12px; white-space: nowrap; font-weight: 700; margin-top: 30px;">ê¸°ìˆ™ì‚¬ìƒë“¤ì„ ìœ„í•œ ì»¤ë®¤ë‹ˆí‹°</span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- í…Œë§ˆ ì„ íƒ ë°•ìŠ¤ -->
                    <select v-model="currentTheme" @change="changeTheme(currentTheme)" 
                            class="p-1 border rounded text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/80">
                        <option value="light">ğŸŒ ë¼ì´íŠ¸</option>
                        <option value="dark">ğŸŒ™ ë‹¤í¬</option>
                        <option value="blue">ğŸŒ¿ ë¯¼íŠ¸</option>
                        <option value="pink">ğŸŒ¸ ë²šê½ƒ</option>
                    </select>
                    <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
                    <button @click="logout" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded hover:bg-gray-300 transition">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="flex-grow flex items-center justify-center py-12 px-4">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-100 transition-colors">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">ğŸ‘¤ ë§ˆì´í˜ì´ì§€</h1>
                
                <div class="mb-8 text-center p-4 rounded-lg transition-colors" style="background-color: #FFFEF5;">
                    <p style="color: #4E3B2D;">ì•ˆë…•í•˜ì„¸ìš”,</p>
                    <p class="text-2xl font-bold mt-1" style="color: #4E3B2D;">{{ loggedInUser }}ë‹˜!</p>
                </div>

                <!-- 1. ì •ë³´ ìˆ˜ì • -->
                <div class="mb-8">
                    <h2 class="text-lg font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2">âœï¸ ì •ë³´ ìˆ˜ì •</h2>
                    <form @submit.prevent="updateInfo">
                        <div class="mb-4">
                            <label class="block mb-1 text-sm font-bold text-gray-600">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ <span class="text-red-500">*</span></label>
                            <input type="password" v-model="currentPassword" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none transition-colors" placeholder="ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>

                        <div class="mb-4">
                            <label class="block mb-1 text-sm font-bold text-gray-600">ìƒˆ ì•„ì´ë”” (ë³€ê²½ ì‹œ ì…ë ¥)</label>
                            <input type="text" v-model="newUsername" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none transition-colors" :placeholder="loggedInUser">
                        </div>

                        <div class="mb-6">
                            <label class="block mb-1 text-sm font-bold text-gray-600">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ ì‹œ ì…ë ¥)</label>
                            <input type="password" v-model="newPassword" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none transition-colors" placeholder="ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”">
                        </div>

                        <button type="submit" class="w-full font-bold py-2 rounded hover:opacity-90 transition shadow-md" style="background-color: #FFF9D9; color: #1f2937;">ì •ë³´ ìˆ˜ì •í•˜ê¸°</button>
                    </form>
                </div>

                <!-- 2. íšŒì› íƒˆí‡´ -->
                <div>
                    <h2 class="text-lg font-bold text-red-600 mb-4 border-b border-red-200 pb-2">âš ï¸ íšŒì› íƒˆí‡´</h2>
                    <p class="text-sm text-gray-500 mb-4">íƒˆí‡´ ì‹œ ì‘ì„±í•œ ê¸€ê³¼ ëŒ“ê¸€ì€ ìœ ì§€ë˜ì§€ë§Œ, íšŒì› ì •ë³´ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>

                    <form @submit.prevent="withdraw">
                        <div class="mb-4">
                            <label class="block mb-1 text-sm font-bold text-gray-600">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" v-model="withdrawPassword" class="w-full border border-red-300 p-2 rounded focus:ring-2 focus:ring-red-500 outline-none transition-colors" placeholder="íƒˆí‡´í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required>
                        </div>
                        <button type="submit" class="w-full font-bold py-2 rounded hover:opacity-90 transition shadow-md" style="background-color: #D66A58; color: #ffffff;">íƒˆí‡´í•˜ê¸°</button>
                    </form>
                </div>
                
                <div class="mt-8 text-center">
                    <a href="/main.html" class="text-sm text-gray-500 hover:underline">&larr; ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loggedInUser: localStorage.getItem('loggedInUser'),
                    currentTheme: 'light',
                    currentPassword: '',
                    newUsername: '',
                    newPassword: '',
                    withdrawPassword: '',
                    // â˜…â˜…â˜… [ì¶”ê°€] ë²šê½ƒ íš¨ê³¼ ì¸í„°ë²Œ ë³€ìˆ˜ â˜…â˜…â˜…
                    cherryBlossomInterval: null
                }
            },
            mounted() {
                // ë¡œê·¸ì¸ ì²´í¬ ë° í…Œë§ˆ ì ìš©
                if (!this.loggedInUser) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    try {
                        window.location.href = '/login.html';
                    } catch (e) {
                        console.warn("í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ (í”„ë¦¬ë·° í™˜ê²½):", e);
                    }
                    return;
                }

                const savedTheme = localStorage.getItem('userTheme') || 'light';
                this.currentTheme = savedTheme;
                document.body.className = `theme-${savedTheme}`;

                // â˜…â˜…â˜… [ì¶”ê°€] ì´ˆê¸° í…Œë§ˆê°€ ë²šê½ƒì´ë©´ ë²šê½ƒ íš¨ê³¼ ì‹œì‘ â˜…â˜…â˜…
                if (savedTheme === 'pink') {
                    this.startCherryBlossoms();
                }

                this.newUsername = this.loggedInUser;
            },
            methods: {
                async changeTheme(newTheme) {
                    this.currentTheme = newTheme;
                    document.body.className = `theme-${newTheme}`; 
                    localStorage.setItem('userTheme', newTheme);

                    // â˜…â˜…â˜… [ì¶”ê°€] ë²šê½ƒ í…Œë§ˆì¼ ë•Œ íš¨ê³¼ ì‹œì‘, ì•„ë‹ˆë©´ ì •ì§€ â˜…â˜…â˜…
                    if (newTheme === 'pink') {
                        this.startCherryBlossoms();
                    } else {
                        this.stopCherryBlossoms();
                    }
                    
                    try {
                        // â˜… ìˆ˜ì •: ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© (/api/theme)
                        await axios.post('/api/theme', {
                            username: this.loggedInUser,
                            theme: newTheme
                        });
                    } catch (e) { console.warn("í…Œë§ˆ ì €ì¥ ì‹¤íŒ¨:", e); }
                },

                // â˜…â˜…â˜… [ì¶”ê°€] ë²šê½ƒ ìƒì„± ë¡œì§ â˜…â˜…â˜…
                startCherryBlossoms() {
                    if (this.cherryBlossomInterval) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ë¬´ì‹œ
                    // 0.3ì´ˆë§ˆë‹¤ ê½ƒì ìƒì„±
                    this.cherryBlossomInterval = setInterval(this.createPetal, 300);
                },
                stopCherryBlossoms() {
                    if (this.cherryBlossomInterval) {
                        clearInterval(this.cherryBlossomInterval);
                        this.cherryBlossomInterval = null;
                    }
                    // ê¸°ì¡´ ê½ƒìë“¤ ì œê±°
                    const petals = document.querySelectorAll('.cherry-blossom');
                    petals.forEach(petal => petal.remove());
                },
                createPetal() {
                    const petal = document.createElement('div');
                    petal.classList.add('cherry-blossom');
                    
                    // ëœë¤ ìœ„ì¹˜ ë° ì†ë„ ì„¤ì •
                    const startLeft = Math.random() * window.innerWidth;
                    const duration = Math.random() * 5 + 5 + 's'; // 5~10ì´ˆ
                    const size = Math.random() * 10 + 10 + 'px'; // 10~20px
                    
                    petal.style.left = startLeft + 'px';
                    petal.style.animationDuration = duration;
                    petal.style.width = size;
                    petal.style.height = size;
                    
                    document.body.appendChild(petal);
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ëë‚˜ë©´ ìš”ì†Œ ì‚­ì œ (ë©”ëª¨ë¦¬ ê´€ë¦¬)
                    setTimeout(() => {
                        petal.remove();
                    }, parseFloat(duration) * 1000);
                },

                async updateInfo() {
                    if (this.newUsername === this.loggedInUser && !this.newPassword) {
                        return alert("ë³€ê²½í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    }

                    try {
                        // â˜… ìˆ˜ì •: ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© (/api/update)
                        const response = await axios.post('/api/update', {
                            currentUsername: this.loggedInUser,
                            currentPassword: this.currentPassword,
                            newUsername: this.newUsername,
                            newPassword: this.newPassword
                        });

                        alert('ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        
                        if (response.data.username) {
                            localStorage.setItem('loggedInUser', response.data.username);
                            this.loggedInUser = response.data.username;
                        }
                        
                        this.currentPassword = '';
                        this.newPassword = '';

                    } catch (error) {
                        let msg = "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                        if (error.response && error.response.data) {
                             msg = typeof error.response.data === 'object' ? 
                                   (error.response.data.message || JSON.stringify(error.response.data)) : 
                                   error.response.data;
                        }
                        alert("ìˆ˜ì • ì‹¤íŒ¨: " + msg);
                    }
                },

                async withdraw() {
                    if (!confirm("ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

                    try {
                        // â˜… ìˆ˜ì •: ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© (/api/withdraw)
                        await axios.post('/api/withdraw', {
                            username: this.loggedInUser,
                            password: this.withdrawPassword
                        });
                        
                        alert('íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.');
                        this.logout();
                        
                    } catch (error) {
                        let msg = "ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
                        if (error.response && error.response.data) {
                             msg = typeof error.response.data === 'object' ? 
                                   (error.response.data.message || JSON.stringify(error.response.data)) : 
                                   error.response.data;
                        }
                        alert("íƒˆí‡´ ì‹¤íŒ¨: " + msg);
                    }
                },
                
                logout() {
                    localStorage.removeItem('loggedInUser');
                    try { window.location.href = '/main.html'; } catch(e) {}
                },
                
                goToMain() {
                    try { window.location.href = '/main.html'; } catch(e) {}
                }
            }
        }).mount('#app');
    </script>
</body>
</html>