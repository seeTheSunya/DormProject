<!-- src/main/resources/static/index.html -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>로그인</title>
    <link rel="stylesheet" href="/assets/doran.css" />
  </head>
  <body>
    <div class="page">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="logo-center" style="display: flex; align-items: center; justify-content: center; width: 100%;">
              <img src="/assets/doran-logo.png" alt="도란 로고" class="center-logo" style="width: 70%; height: auto; transform: scale(0.7); transform-origin: center; margin: 0 auto; display: block;" onerror="this.src='/assets/doran-logo.jpg'; this.onerror=null;" />
            </div>
            <div class="card-title">로그인</div>
            <div class="card-subtitle">
              기숙사생을 위한 커뮤니티, 도란에 오신 것을 환영합니다.
            </div>
          </div>
        </div>

        <form class="form" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="label">아이디</label>
            <input
              id="login-username"
              class="input"
              placeholder="아이디를 입력하세요"
              required
            />
          </div>

          <div class="form-group">
            <label class="label">비밀번호</label>
            <input
              id="login-password"
              class="input"
              type="password"
              placeholder="비밀번호를 입력하세요"
              required
            />
          </div>

          <button class="btn btn-primary" type="submit">로그인</button>

          <div id="loginMessage" class="message"></div>
        </form>

        <div class="footer-text">
          보안을 위해 <strong>5분간 입력이 없으면 자동으로 새로고침</strong> 됩니다.
        </div>
      </div>
    </div>

    <script>
      async function handleLogin(event) {
        event.preventDefault();
        const username = document
          .getElementById("login-username")
          .value.trim();
        const password = document.getElementById("login-password").value;
        const msg = document.getElementById("loginMessage");
        msg.textContent = "";

        try {
          const res = await fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          if (!res.ok) {
            const text = await res.text();
            msg.textContent = text || "로그인에 실패했습니다.";
            msg.className = "message message-error";
            return;
          }

          const data = await res.json();
          // localStorage에 로그인 아이디 저장
          localStorage.setItem("loggedInUsername", data.username || username);

          // 임시 비밀번호인지 확인해서 처리
          if (data.mustChangePassword) {
            // 임시 비밀번호 사용 중이면 비번 재설정 페이지로
            location.href = "change-password.html";
          } else {
            location.href = "main.html";
          }
        } catch (e) {
          console.error(e);
          msg.textContent = "서버 오류가 발생했습니다.";
          msg.className = "message message-error";
        }
      }

      // ===== 5분 동안 입력 없으면 새로고침 =====
      let idleTimer;
      function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(() => {
          location.reload();
        }, 5 * 60 * 1000); // 5분
      }

      ["click", "keydown", "mousemove", "scroll", "touchstart"].forEach((ev) =>
        window.addEventListener(ev, resetIdleTimer)
      );

      resetIdleTimer();
    </script>
  </body>
</html>
