<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ì“°ê¸° - ë„ë€</title>
    <!-- Vue.js, Tailwind, Axios -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- â˜… Quill Editor CSS & JS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <style>
        /* ì—ë””í„° ë†’ì´ ì„¤ì • */
        .ql-editor { min-height: 400px; font-size: 16px; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        
        /* â˜…â˜…â˜… í…Œë§ˆë³„ ìƒ‰ìƒ ì •ì˜ â˜…â˜…â˜… */
        body.theme-light { background-color: #f3f4f6; color: #1f2937; }
        body.theme-dark { background-color: #111827; color: #e5e7eb; }
        body.theme-dark .bg-white { background-color: #1f2937 !important; border-color: #374151; color: #e5e7eb; }
        body.theme-dark .text-gray-800 { color: #f3f4f6 !important; }
        body.theme-dark .text-gray-600 { color: #9ca3af !important; }
        body.theme-dark .text-gray-700 { color: #e5e7eb !important; }
        body.theme-dark header { background-color: #1f2937 !important; border-bottom: 1px solid #374151; }
        
        /* ë‹¤í¬ëª¨ë“œ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        body.theme-dark input[type="text"],
        body.theme-dark input[type="number"],
        body.theme-dark select {
            background-color: #374151 !important;
            color: #ffffff !important;
            border-color: #4b5563 !important;
        }
        body.theme-dark input::placeholder,
        body.theme-dark input::-webkit-input-placeholder {
            color: #9ca3af !important;
        }
        body.theme-dark input::-moz-placeholder {
            color: #9ca3af !important;
        }
        body.theme-dark label {
            color: #e5e7eb !important;
        }
        body.theme-dark .bg-gray-50 {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
        }
        body.theme-dark .bg-green-50 {
            background-color: #1f2937 !important;
            border-color: #374151 !important;
        }
        
        /* ë‹¤í¬ëª¨ë“œ Quill ì—ë””í„° ìŠ¤íƒ€ì¼ */
        body.theme-dark .ql-container {
            background-color: #374151 !important;
            color: #ffffff !important;
            border-color: #4b5563 !important;
        }
        body.theme-dark .ql-editor {
            color: #ffffff !important;
        }
        body.theme-dark .ql-editor.ql-blank::before {
            color: #9ca3af !important;
        }
        body.theme-dark .ql-toolbar {
            background-color: #1f2937 !important;
            border-color: #4b5563 !important;
        }
        body.theme-dark .ql-stroke {
            stroke: #e5e7eb !important;
        }
        body.theme-dark .ql-fill {
            fill: #e5e7eb !important;
        }
        body.theme-dark .ql-picker-label {
            color: #e5e7eb !important;
        }
        
        /* ë‹¤í¬ëª¨ë“œ ì‡¼í•‘ ê²€ìƒ‰ ê²°ê³¼ ìŠ¤íƒ€ì¼ */
        body.theme-dark .bg-white {
            background-color: #374151 !important;
        }
        body.theme-dark .hover\:bg-green-100:hover {
            background-color: #4b5563 !important;
        }
        
        body.theme-blue { background-color: #f7faf9; color: #5a7a72; }
        body.theme-blue header { background-color: #eaf5f2 !important; }
        body.theme-pink { background-color: #fef5f0; color: #b85d4a; }
        body.theme-pink header { background-color: #fce8df !important; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="min-h-screen pb-20">
        <!-- í—¤ë” -->
        <header class="bg-white shadow-sm sticky top-0 z-20">
            <div class="container mx-auto px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="javascript:history.back()" class="text-gray-500 hover:text-gray-800 text-xl font-bold">â†</a>
                    <h1 class="text-xl font-bold text-gray-800">ìƒˆ ê¸€ ì‘ì„±</h1>
                </div>
                <div class="text-gray-600 text-sm" v-if="loggedInUser">
                    ì‘ì„±ì: <b>{{ loggedInUser }}</b>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-6 max-w-4xl">
            <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
                
                <!-- 1. ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ê²Œì‹œíŒ ì„ íƒ <span class="text-red-500">*</span></label>
                    <select v-model="category" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">ê²Œì‹œíŒì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="group">ğŸ“¢ ê³µë™êµ¬ë§¤ ê²Œì‹œíŒ</option>
                        <option value="review">â­ ì‚¬ìš© í›„ê¸° ê²Œì‹œíŒ</option>
                        <option value="recipe">ğŸ³ ê¸°ìˆ™ì‚¬ ë ˆì‹œí”¼</option>
                        <option value="tip">ğŸ’¡ ìƒí™œ ê¿€íŒ</option>
                        <option value="counseling">ğŸ’¬ ê³ ë¯¼ìƒë‹´ì†Œ</option>
                    </select>
                </div>

                <!-- 2. ì œëª© ì…ë ¥ -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ì œëª© <span class="text-red-500">*</span></label>
                    <input v-model="title" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg font-medium">
                </div>

                <!-- 2-1. ê³µë™êµ¬ë§¤ ì „ìš©: ëª¨ì§‘ ì¸ì› ìˆ˜ -->
                <div v-if="category === 'group'" class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ëª¨ì§‘ ì¸ì› ìˆ˜ <span class="text-red-500">*</span></label>
                    <input v-model="recruitCount" type="number" min="2" placeholder="ì˜ˆ: 4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <!-- 3. ë„êµ¬ ëª¨ìŒ (AI & ì‡¼í•‘) -->
                <div class="flex flex-wrap gap-3 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <!-- AI ì…ë ¥ -->
                    <div class="flex-grow flex gap-2">
                        <input v-model="aiUserPrompt" @keyup.enter="generateAiContent" type="text" 
                               :placeholder="aiPlaceholder" 
                               class="flex-grow p-2 border border-purple-300 rounded text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                        <button @click="generateAiContent" :disabled="isLoadingAi" class="text-gray-800 px-4 py-2 rounded text-sm font-bold hover:opacity-90 disabled:opacity-50 flex items-center gap-2 whitespace-nowrap" style="background-color: #C7B9E5;">
                            <span v-if="isLoadingAi">ìƒì„± ì¤‘...</span>
                            <span v-else>âœ¨ AI ì‘ì„±</span>
                        </button>
                    </div>
                    <!-- ì‡¼í•‘ ê²€ìƒ‰ í† ê¸€ -->
                    <button @click="showShopping = !showShopping" class="text-gray-800 px-4 py-2 rounded text-sm font-bold hover:opacity-90 whitespace-nowrap" style="background-color: #BFD8B8;">
                        ğŸ›ï¸ ìµœì €ê°€ ê²€ìƒ‰
                    </button>
                </div>

                <!-- ì‡¼í•‘ ê²€ìƒ‰ íŒ¨ë„ (ìˆ¨ê¹€/í‘œì‹œ) -->
                <div v-if="showShopping" class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex gap-2 mb-3">
                        <input v-model="shoppingQuery" @keyup.enter="searchShopping" type="text" placeholder="ìƒí’ˆëª… ì…ë ¥ (ì˜ˆ: í–‡ë°˜)" class="flex-grow p-2 border rounded text-sm">
                        <button @click="searchShopping" :disabled="isLoadingShopping" class="text-gray-800 px-3 py-1 rounded text-sm hover:opacity-90" style="background-color: #BFD8B8;">ê²€ìƒ‰</button>
                    </div>
                    <ul v-if="shoppingResults.length > 0" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                        <li v-for="item in shoppingResults" :key="item.productId" @click="addShoppingItem(item)"
                            class="flex items-center gap-3 p-2 bg-white rounded border hover:bg-green-100 cursor-pointer transition">
                            <img :src="item.image" class="w-12 h-12 object-cover rounded">
                            <div class="flex-grow overflow-hidden">
                                <div class="font-medium truncate text-sm" v-html="item.title"></div>
                                <div class="text-red-600 font-bold text-sm">{{ Number(item.lprice).toLocaleString() }}ì›</div>
                            </div>
                            <button class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">ë³¸ë¬¸ì— ì¶”ê°€</button>
                        </li>
                    </ul>
                    <p v-else-if="!isLoadingShopping && shoppingQuery" class="text-center text-gray-500 text-xs">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>

                <!-- 3-1. ê³µë™êµ¬ë§¤ ì „ìš©: ì¸ë‹¹ ì§€ë¶ˆ ê°€ê²© -->
                <div v-if="category === 'group'" class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ì¸ë‹¹ ì§€ë¶ˆ ê°€ê²© <span class="text-red-500">*</span></label>
                    <div class="flex items-center gap-2">
                        <input v-model="pricePerPerson" type="number" min="0" placeholder="ì˜ˆ: 5000" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <span class="text-gray-600 font-semibold">ì›</span>
                    </div>
                </div>

                <!-- â˜…â˜…â˜… 4. Quill Editor ì˜ì—­ â˜…â˜…â˜… -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ë‚´ìš© <span class="text-red-500">*</span></label>
                    <!-- ì´ divê°€ ìŠ¤í¬ë¦½íŠ¸ì— ì˜í•´ ë©‹ì§„ ì—ë””í„°ë¡œ ë³€ì‹ í•©ë‹ˆë‹¤ -->
                    <div id="editor"></div> 
                </div>

                <!-- ë²„íŠ¼ ì˜ì—­ -->
                <div class="flex justify-end gap-3 border-t pt-6">
                    <a href="javascript:history.back()" class="px-6 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-bold">ì·¨ì†Œ</a>
                    <button @click="savePost" class="px-8 py-3 text-white rounded-lg hover:opacity-90 font-bold shadow-md" style="background-color: #D66A58;">ë“±ë¡í•˜ê¸°</button>
                </div>

            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loggedInUser: localStorage.getItem('loggedInUser'),
                    category: '',
                    title: '',
                    content: '', 
                    quill: null, 
                    aiUserPrompt: '',
                    isLoadingAi: false,
                    showShopping: false,
                    shoppingQuery: '',
                    shoppingResults: [],
                    isLoadingShopping: false,
                    // ê³µë™êµ¬ë§¤ ì „ìš© í•„ë“œ
                    recruitCount: '',
                    pricePerPerson: ''
                }
            },
            computed: {
                aiPlaceholder() {
                    return this.category === 'group' 
                        ? "ì˜ˆ: ë‘ë£¨ë§ˆë¦¬ íœ´ì§€ 30ë¡¤ ê³µë™êµ¬ë§¤ ëª¨ì§‘ê¸€ ì¨ì¤˜" 
                        : "ì˜ˆ: ìì·¨ìƒ ê°„ë‹¨ ìš”ë¦¬ ë ˆì‹œí”¼ ì¶”ì²œí•´ì¤˜";
                }
            },
            mounted() {
                // â˜…â˜…â˜… í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í…Œë§ˆ ë¶ˆëŸ¬ì˜¤ê¸° â˜…â˜…â˜…
                const savedTheme = localStorage.getItem('userTheme') || 'light';
                document.body.className = `theme-${savedTheme}`;
                
                // â˜… ìˆ˜ì •: ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ try-catch ì¶”ê°€
                if (!this.loggedInUser) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    try {
                        window.location.href = '/login.html'; // ì ˆëŒ€ ê²½ë¡œë¡œ ìˆ˜ì •
                    } catch (e) {
                        console.warn("í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (í”„ë¦¬ë·° í™˜ê²½):", e);
                    }
                    return;
                }

                const params = new URLSearchParams(window.location.search);
                const catParam = params.get('category');
                if (catParam) this.category = catParam;

                // â˜… Quill ì—ë””í„° ì´ˆê¸°í™” (ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ê°€ ì—†ì–´ì•¼ ì—¬ê¸°ê¹Œì§€ ì‹¤í–‰ë©ë‹ˆë‹¤)
                this.initQuill();
            },
            methods: {
                initQuill() {
                    // â˜… Quill ì—ë””í„° ìƒì„± ì½”ë“œ
                    this.quill = new Quill('#editor', {
                        theme: 'snow',
                        placeholder: 'ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”...',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'color': [] }, { 'background': [] }],
                                ['link', 'image'],
                                ['clean']
                            ]
                        }
                    });

                    this.quill.on('text-change', () => {
                        this.content = this.quill.root.innerHTML;
                    });
                },

                async savePost() {
                    // ì¹´í…Œê³ ë¦¬ í•„ìˆ˜ ì²´í¬
                    if (!this.category) {
                        return alert("ê²Œì‹œíŒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    }
                    
                    // ì œëª© í•„ìˆ˜ ì²´í¬
                    if (!this.title.trim()) {
                        return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    }
                    
                    // ë‚´ìš© í•„ìˆ˜ ì²´í¬ (HTML íƒœê·¸ ì œì™¸í•˜ê³  í…ìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸)
                    if (this.quill.getText().trim().length === 0) {
                        return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    }
                    
                    // ê³µë™êµ¬ë§¤ ê²Œì‹œíŒ í•„ìˆ˜ í•„ë“œ ì²´í¬
                    if (this.category === 'group') {
                        if (!this.recruitCount || parseInt(this.recruitCount) < 2) {
                            return alert("ëª¨ì§‘ ì¸ì› ìˆ˜ë¥¼ 2ëª… ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        }
                        if (!this.pricePerPerson || parseInt(this.pricePerPerson) <= 0) {
                            return alert("ì¸ë‹¹ ì§€ë¶ˆ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        }
                    }

                    try {
                        const postData = {
                            title: this.title.trim(),
                            content: this.content, 
                            category: this.category,
                            username: this.loggedInUser
                        };
                        
                        // ê³µë™êµ¬ë§¤ ê²Œì‹œíŒì¸ ê²½ìš° ì¶”ê°€ í•„ë“œ í¬í•¨
                        if (this.category === 'group') {
                            postData.recruitCount = parseInt(this.recruitCount);
                            postData.pricePerPerson = parseInt(this.pricePerPerson);
                        }
                        
                        await axios.post('http://localhost:8081/api/posts', postData);
                        alert("ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        window.location.href = `board.html?category=${this.category}`;
                    } catch (e) {
                        alert("ì €ì¥ ì‹¤íŒ¨: " + (e.response?.data || "ì„œë²„ ì˜¤ë¥˜"));
                    }
                },

                async generateAiContent() {
                    this.isLoadingAi = true;
                    
                    let prompt = this.aiUserPrompt;
                    if (!prompt) {
                        if (this.category === 'group') prompt = "ê¸°ìˆ™ì‚¬ ê³µë™êµ¬ë§¤ ëª¨ì§‘ê¸€ì„ ì‘ì„±í•´ì¤˜.";
                        else if (this.category === 'recipe') prompt = "ê°„ë‹¨í•œ ê¸°ìˆ™ì‚¬ ìš”ë¦¬ ë ˆì‹œí”¼ í•˜ë‚˜ ì¶”ì²œí•´ì¤˜.";
                        else prompt = "ê²Œì‹œê¸€ ë‚´ìš©ì„ ì‘ì„±í•´ì¤˜.";
                    }

                    try {
                        const res = await axios.post('http://localhost:8081/api/ai/generate', { prompt }, { timeout: 20000 });
                        const text = res.data.text;

                        // ì¤„ë°”ê¿ˆì„ HTML íƒœê·¸ë¡œ ë³€í™˜í•˜ì—¬ ì—ë””í„°ì— ì‚½ì…
                        const formattedText = text.split('\n').map(line => `<p>${line}</p>`).join('');
                        const currentHtml = this.quill.root.innerHTML;
                        this.quill.root.innerHTML = currentHtml + formattedText;
                        
                        if (!this.title) this.title = text.split('\n')[0].substring(0, 30);
                        this.aiUserPrompt = '';
                    } catch (e) {
                        alert("AI ìƒì„± ì‹¤íŒ¨: " + e.message);
                    } finally {
                        this.isLoadingAi = false;
                    }
                },

                async searchShopping() {
                    if (!this.shoppingQuery.trim()) return;
                    this.isLoadingShopping = true;
                    this.shoppingResults = [];
                    try {
                        const res = await axios.get(`http://localhost:8081/api/naver/search?query=${this.shoppingQuery}`);
                        this.shoppingResults = res.data.items;
                    } catch (e) {
                        alert("ê²€ìƒ‰ ì‹¤íŒ¨");
                    } finally {
                        this.isLoadingShopping = false;
                    }
                },

                addShoppingItem(item) {
                    const title = item.title.replace(/<b>/g, '').replace(/<\/b>/g, '');
                    const price = Number(item.lprice).toLocaleString();
                    
                    // ì˜ˆìœ ì¹´ë“œ í˜•íƒœë¡œ ì—ë””í„°ì— ì‚½ì…
                    const htmlCard = `
                        <br>
                        <div style="border:1px solid #ddd; padding:10px; border-radius:8px; display:flex; align-items:center; gap:10px; background-color:#f9fafb;">
                            <img src="${item.image}" style="width:60px; height:60px; object-fit:cover; border-radius:4px;">
                            <div>
                                <div style="font-weight:bold; font-size:14px;">${title}</div>
                                <div style="color:#e11d48; font-weight:bold;">ìµœì €ê°€ ${price}ì›</div>
                                <a href="${item.link}" target="_blank" style="font-size:12px; color:#2563eb; text-decoration:underline;">êµ¬ë§¤í•˜ëŸ¬ ê°€ê¸° &rarr;</a>
                            </div>
                        </div>
                        <br>
                    `;
                    
                    const range = this.quill.getSelection(true);
                    // ì»¤ì„œ ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ë§¨ ë’¤ì— ì‚½ì…
                    const index = range ? range.index : this.quill.getLength();
                    this.quill.clipboard.dangerouslyPasteHTML(index, htmlCard);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>