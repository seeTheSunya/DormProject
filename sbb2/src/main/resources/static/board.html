<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œíŒ</title>
    <!-- Vue.js CDN (ì „ì—­ ë¹Œë“œ) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Axios CDN: ì„œë²„ í†µì‹ ìš© -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- â˜…â˜…â˜… ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì—°ê²° â˜…â˜…â˜… -->
    <link rel="stylesheet" href="doran.css">
    
    <style>
        /* board.html ì „ìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        
        /* 1. ë¼ì´íŠ¸ ëª¨ë“œ ê²Œì‹œíŒ ìŠ¤íƒ€ì¼ */
        body.theme-light .board-container { background-color: #ffffff; border: 1px solid #e5e7eb; }
        body.theme-light .board-header { background-color: #ffffff; color: #1f2937; border-bottom: 1px solid #e5e7eb; }
        body.theme-light table thead { background-color: #f9fafb; color: #4b5563; border-bottom: 1px solid #e5e7eb; }
        body.theme-light table tbody tr { border-bottom: 1px solid #e5e7eb; }
        body.theme-light table tbody tr:hover { background-color: #f9fafb; }
        body.theme-light table td { color: #1f2937; }

        /* 2. ë‹¤í¬ ëª¨ë“œ ê²Œì‹œíŒ ìŠ¤íƒ€ì¼ */
        body.theme-dark .board-container { background-color: #1f2937; border: 1px solid #374151; }
        body.theme-dark .board-header { background-color: #374151; color: #ffffff; border-bottom: 1px solid #4b5563; }
        body.theme-dark table thead { background-color: #374151; color: #d1d5db; border-bottom: 1px solid #4b5563; }
        body.theme-dark table tbody tr { border-bottom: 1px solid #374151; }
        body.theme-dark table tbody tr:hover { background-color: #374151; }
        body.theme-dark table td { color: #e5e7eb; }
        body.theme-dark .text-sub { color: #9ca3af; }
        
        body.theme-dark input, body.theme-dark select.sort-select {
            background-color: #374151;  
            color: #ffffff;             
            border: 1px solid #4b5563;  
        }
        body.theme-dark input::placeholder { color: #9ca3af; }

        /* 3. ë¯¼íŠ¸ ëª¨ë“œ ê²Œì‹œíŒ ìŠ¤íƒ€ì¼ */
        body.theme-blue .board-container { background-color: #ffffff; border: 1px solid #bce3d4; }
        body.theme-blue .board-header { background-color: #5a7a72; color: #ffffff; border-bottom: 1px solid #bce3d4; }
        body.theme-blue table thead { background-color: #eaf5f2; color: #5a7a72; border-bottom: 1px solid #bce3d4; }
        body.theme-blue table tbody tr { border-bottom: 1px solid #e2e8f0; }
        body.theme-blue table tbody tr:hover { background-color: #f0fdf4; }
        body.theme-blue table td { color: #2c3e50; }

        /* 4. í•‘í¬ ëª¨ë“œ ê²Œì‹œíŒ ìŠ¤íƒ€ì¼ */
        body.theme-pink .board-container { background-color: #ffffff; border: 1px solid #fed7aa; }
        body.theme-pink .board-header { background-color: #d66a58; color: #ffffff; border-bottom: 1px solid #fed7aa; }
        body.theme-pink table thead { background-color: #fff1f2; color: #b85d4a; border-bottom: 1px solid #fed7aa; }
        body.theme-pink table tbody tr { border-bottom: 1px solid #ffe4e6; }
        body.theme-pink table tbody tr:hover { background-color: #fff1f2; }
        body.theme-pink table td { color: #4a0e0e; }

        /* â˜…â˜…â˜… [ìˆ˜ì •] ê²Œì‹œê¸€ ë¯¸ë¦¬ë³´ê¸° íŒì—… ìŠ¤íƒ€ì¼ (ì˜ë¦¼ í•´ê²°) â˜…â˜…â˜… */
        .title-cell {
            position: relative; /* íŒì—… ìœ„ì¹˜ ê¸°ì¤€ì  */
            overflow: visible !important; /* â˜… ì¤‘ìš”: ë‚´ìš©ì´ ë„˜ì³ë„ ë³´ì´ê²Œ ì„¤ì • */
        }
        .preview-popup {
            display: none; 
            position: absolute;
            top: 100%; 
            left: 10px;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì ê°•í™” */
            padding: 1rem;
            z-index: 9999; /* â˜… ì¤‘ìš”: ì•„ì£¼ ë†’ì€ ê°’ìœ¼ë¡œ ì„¤ì • */
            white-space: normal; 
            text-align: left;
        }
        /* ì œëª©ì— ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ íŒì—… í‘œì‹œ */
        .title-cell:hover .preview-popup {
            display: block;
        }
        /* ë¯¸ë¦¬ë³´ê¸° ë‚´ë¶€ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .preview-popup img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        /* ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ */
        body.theme-dark .preview-popup {
            background-color: #1f2937;
            border-color: #374151;
            color: #e5e7eb;
        }
        
        /* â˜… ì¤‘ìš”: íŒì—…ì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ ì»¨í…Œì´ë„ˆ ì˜¤ë²„í”Œë¡œìš° í•´ì œ */
        .board-container {
            overflow: visible !important; 
        }

        /* ë²šê½ƒ íš¨ê³¼ */
        .cherry-blossom {
            position: fixed; top: -10px; background-color: #FFB7C5; 
            border-radius: 150% 0 150% 0; pointer-events: none; z-index: 9999; opacity: 0.8; animation: fall linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg) translateX(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg) translateX(50px); opacity: 0; }
        }
    </style>
</head>
<body :class="'theme-' + currentTheme">
    <div id="app">
        <div class="min-h-screen font-sans transition-colors duration-300">
            <!-- ìƒë‹¨ í—¤ë” -->
            <header class="bg-white shadow-sm sticky top-0 z-10 transition-colors duration-300">
                <div class="container mx-auto px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center cursor-pointer" @click="goToMain" style="margin-left: -60px;">
                        <img src="/assets/doran-logo2.png" alt="ë„ë€ ë¡œê³ " style="height: 49px; object-fit: contain;" onerror="this.style.display='none';">
                        <span class="text-xs text-gray-600 ml-2 font-bold" style="font-size: 12px; white-space: nowrap; font-weight: 700; margin-top: 30px;">ê¸°ìˆ™ì‚¬ìƒë“¤ì„ ìœ„í•œ ì»¤ë®¤ë‹ˆí‹°</span>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <select v-model="currentTheme" @change="changeTheme(currentTheme)" 
                                class="p-1 border rounded text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/80 cursor-pointer transition-colors">
                            <option value="light">ğŸŒ ë¼ì´íŠ¸</option>
                            <option value="dark">ğŸŒ™ ë‹¤í¬</option>
                            <option value="blue">ğŸŒ¿ ë¯¼íŠ¸</option>
                            <option value="pink">ğŸŒ¸ ë²šê½ƒ</option>
                        </select>

                        <div v-if="loggedInUser" class="flex items-center space-x-3">
                            <span class="mypage-btn cursor-default text-sm"><b>{{ loggedInUser }}</b>ë‹˜</span>
                            <button @click="goToMyPage" class="mypage-btn font-semibold transition mr-2 text-sm hover:text-blue-500">
                                ë§ˆì´í˜ì´ì§€
                            </button>
                            <button @click="logout" class="logout-btn font-semibold px-4 py-2 rounded transition text-sm">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                        <button v-else @click="goToLogin" class="text-white font-semibold px-4 py-2 rounded hover:opacity-90 transition text-sm" style="background-color: #D66A58;">
                            ë¡œê·¸ì¸
                        </button>
                    </div>
                </div>
            </header>

            <main class="container mx-auto p-4 md:p-6 pb-12">
                <!-- 1. ë¡œê·¸ì¸ ì ê¸ˆ í™”ë©´ -->
                <div v-if="!loggedInUser" class="flex flex-col items-center justify-center py-20 text-center animate-fade-in-up">
                    <div class="bg-white p-10 max-w-lg w-full" style="border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.06);">
                        <div class="mb-4 flex justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#4E3B2D" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</h2>
                        <p class="text-gray-600 mb-8">ê¸°ìˆ™ì‚¬ìƒë“¤ê³¼ ì†Œí†µí•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.</p>
                        <button @click="goToLogin" class="w-full text-white text-lg font-bold py-3 rounded-lg transition shadow-lg hover:opacity-90" style="background-color: #D66A58;">
                            ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°
                        </button>
                    </div>
                </div>

                <!-- 2. ë¡œê·¸ì¸ í›„: ê²Œì‹œê¸€ ëª©ë¡ -->
                <div v-else class="animate-fade-in-up">

                    <div class="board-container rounded-lg shadow-md transition-colors duration-300">
                        <!-- ê²Œì‹œíŒ í—¤ë” -->
                        <div class="board-header flex flex-col md:flex-row justify-between items-center p-5 gap-4 transition-colors duration-300">
                            <h2 class="text-xl font-bold">{{ categoryTitle }}</h2>
                            <div class="flex items-center space-x-2 w-full md:w-auto flex-wrap md:flex-nowrap">
                                
                                <!-- â˜…â˜…â˜… ì •ë ¬ ì„ íƒ ì˜µì…˜ ì¶”ê°€ â˜…â˜…â˜… -->
                                <select v-model="sortMode" @change="sortPosts" class="sort-select p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer bg-white">
                                    <option value="latest">ìµœì‹ ìˆœ</option>
                                    <option value="popular">ì¸ê¸°ìˆœ</option>
                                </select>

                                <div class="relative flex-grow md:flex-grow-0">
                                    <input v-model="searchKeyword" @keyup.enter="fetchPosts" type="text" placeholder="ì œëª© ê²€ìƒ‰..." class="w-full md:w-64 pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                    <span class="absolute left-3 top-2.5 opacity-50">ğŸ”</span>
                                </div>
                                <button @click="fetchPosts" class="search-btn font-semibold px-4 py-2 rounded-lg transition border text-sm md:text-base">ê²€ìƒ‰</button>
                                <button @click="goToWrite" class="font-semibold px-5 py-2 rounded-lg hover:opacity-90 transition shadow-sm whitespace-nowrap text-sm md:text-base" style="background-color: #FFF9D9; color: #1f2937;">+ ê¸€ì“°ê¸°</button>
                            </div>
                        </div>
                        
                        <!-- í…Œì´ë¸” -->
                        <table class="w-full min-w-full">
                            <thead>
                                <tr>
                                    <th class="p-4 text-left text-sm font-semibold w-16 md:w-20">ë²ˆí˜¸</th>
                                    <th class="p-4 text-left text-sm font-semibold">ì œëª©</th>
                                    <th class="p-4 text-left text-sm font-semibold w-24 md:w-32">ì‘ì„±ì</th>
                                    <th class="p-4 text-left text-sm font-semibold w-24 md:w-32">ì‘ì„±ì¼</th>
                                    <th class="p-4 text-left text-sm font-semibold w-16 md:w-20 hidden md:table-cell">ì¢‹ì•„ìš”</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-if="posts.length === 0">
                                    <td colspan="5" class="p-10 text-center opacity-60">
                                        <span v-if="searchKeyword">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                                        <span v-else>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                                    </td>
                                </tr>
                                <tr v-for="(post, index) in posts" :key="post.id" @click="goToDetail(post.id)" class="cursor-pointer transition duration-150">
                                    <td class="p-4 text-sub text-sm">{{ index + 1 }}</td>
                                    
                                    <!-- ì œëª© ì¹¸ + ë¯¸ë¦¬ë³´ê¸° -->
                                    <td class="p-4 font-medium truncate title-cell max-w-[150px] md:max-w-xs">
                                        <div class="flex items-center">
                                            <span class="truncate">{{ post.title }}</span>
                                            <!-- ì¢‹ì•„ìš”ê°€ ë§ìœ¼ë©´ ì¸ê¸° ì•„ì´ì½˜ í‘œì‹œ -->
                                            <span v-if="post.likeCount >= 5" class="ml-2 text-xs text-red-500 font-bold border border-red-200 bg-red-50 px-1 rounded">HOT</span>
                                        </div>
                                        <div class="preview-popup custom-scrollbar" @click.stop>
                                            <div v-html="post.content" class="text-sm text-gray-600"></div>
                                        </div>
                                    </td>
                                    
                                    <td class="p-4 text-sub text-sm truncate">{{ post.member ? post.member.username : 'ìµëª…' }}</td>
                                    <td class="p-4 text-sub text-sm">{{ formatDate(post.createdAt) }}</td>
                                    <td class="p-4 text-sub text-sm hidden md:table-cell text-red-500 font-medium">â™¥ {{ post.likeCount || 0 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        if (typeof Vue === 'undefined') alert("Vue.js ë¡œë“œ ì‹¤íŒ¨");
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    loggedInUser: localStorage.getItem('loggedInUser') || null,
                    posts: [],
                    category: null, 
                    categoryTitle: 'ê²Œì‹œíŒ',
                    searchKeyword: '',
                    currentTheme: 'light',
                    sortMode: 'latest', // â˜… ì •ë ¬ ëª¨ë“œ (latest ë˜ëŠ” popular)
                    cherryBlossomInterval: null
                }
            },
            mounted() {
                const savedTheme = localStorage.getItem('userTheme') || 'light';
                this.currentTheme = savedTheme;
                document.body.className = `theme-${savedTheme}`;

                if (savedTheme === 'pink') this.startCherryBlossoms();
                
                const params = new URLSearchParams(window.location.search);
                this.category = params.get('category'); 
                this.setCategoryTitle();
                
                if (this.loggedInUser) {
                    this.fetchPosts();
                }
            },
            methods: {
                async changeTheme(theme) {
                    this.currentTheme = theme;
                    document.body.className = `theme-${theme}`; 
                    localStorage.setItem('userTheme', theme);
                    if (theme === 'pink') this.startCherryBlossoms(); else this.stopCherryBlossoms();
                    if (this.loggedInUser) {
                        try { await axios.post('/api/theme', { username: this.loggedInUser, theme: theme }); } catch (e) {}
                    }
                },
                startCherryBlossoms() {
                    if (this.cherryBlossomInterval) return;
                    this.cherryBlossomInterval = setInterval(this.createPetal, 300);
                },
                stopCherryBlossoms() {
                    if (this.cherryBlossomInterval) {
                        clearInterval(this.cherryBlossomInterval);
                        this.cherryBlossomInterval = null;
                    }
                    document.querySelectorAll('.cherry-blossom').forEach(p => p.remove());
                },
                createPetal() {
                    const petal = document.createElement('div');
                    petal.classList.add('cherry-blossom');
                    const startLeft = Math.random() * window.innerWidth;
                    const duration = Math.random() * 5 + 5 + 's';
                    const size = Math.random() * 10 + 10 + 'px';
                    petal.style.left = startLeft + 'px';
                    petal.style.animationDuration = duration;
                    petal.style.width = size;
                    petal.style.height = size;
                    document.body.appendChild(petal);
                    setTimeout(() => petal.remove(), parseFloat(duration) * 1000);
                },
                
                setCategoryTitle() {
                    const titles = { group: 'ğŸ“¢ ê³µë™êµ¬ë§¤', review: 'â­ ì‚¬ìš© í›„ê¸°', recipe: 'ğŸ³ ê¸°ìˆ™ì‚¬ ë ˆì‹œí”¼', tip: 'ğŸ’¡ ìƒí™œ ê¿€íŒ', counseling: 'ğŸ’¬ ê³ ë¯¼ìƒë‹´ì†Œ' };
                    this.categoryTitle = titles[this.category] || 'ê²Œì‹œíŒ';
                },
                
                async fetchPosts() {
                    try {
                        // 1. ì„œë²„ì—ì„œ ëª¨ë“  ê¸€ ê°€ì ¸ì˜¤ê¸°
                        const response = await axios.get('/api/posts');
                        let fetchedPosts = response.data;

                        // 2. ì¹´í…Œê³ ë¦¬ í•„í„°ë§
                        if (this.category) {
                            fetchedPosts = fetchedPosts.filter(p => p.category === this.category);
                        }

                        // 3. ê²€ìƒ‰ì–´ í•„í„°ë§
                        if (this.searchKeyword.trim()) {
                            const keyword = this.searchKeyword.trim().toLowerCase();
                            fetchedPosts = fetchedPosts.filter(p => 
                                p.title.toLowerCase().includes(keyword)
                            );
                        }

                        this.posts = fetchedPosts;
                        
                        // 4. ì •ë ¬ ì ìš© (ë°ì´í„° ë¡œë“œ í›„ ì¦‰ì‹œ ì •ë ¬)
                        this.sortPosts();

                    } catch (error) { 
                        console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                        alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                },

                // â˜… ì •ë ¬ í•¨ìˆ˜: Vue ë°ì´í„°(posts)ë¥¼ ì§ì ‘ ì •ë ¬í•©ë‹ˆë‹¤.
                sortPosts() {
                    if (this.sortMode === 'latest') {
                        // ìµœì‹ ìˆœ: ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ
                        this.posts.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                    } else if (this.sortMode === 'popular') {
                        // ì¸ê¸°ìˆœ: ì¢‹ì•„ìš” ë‚´ë¦¼ì°¨ìˆœ -> (ë™ë¥ ì‹œ) ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ
                        this.posts.sort((a, b) => {
                            const likeDiff = (b.likeCount || 0) - (a.likeCount || 0);
                            if (likeDiff !== 0) return likeDiff;
                            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                        });
                    }
                },
                
                goToLogin() { try { window.location.href = 'login.html'; } catch(e) {} },
                goToMyPage() { try { window.location.href = 'mypage.html'; } catch(e) {} },
                goToMain() { try { window.location.href = 'main.html'; } catch(e) {} },
                
                goToWrite() {
                    try { window.location.href = `write.html?category=${this.category}`; } catch (e) {}
                },
                goToDetail(postId) { 
                    try { window.location.href = `detail.html?id=${postId}`; } catch(e) {}
                },
                logout() {
                    localStorage.removeItem('loggedInUser');
                    this.loggedInUser = null;
                    this.posts = [];
                    alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    try { location.reload(); } catch(e) {}
                },
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return `${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>