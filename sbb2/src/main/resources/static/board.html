<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Vue.js CDN (ì „ì—­ ë¹Œë“œ) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Axios CDN: ì„œë²„ í†µì‹ ìš© -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>ê²Œì‹œíŒ</title>
    <style>
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app">
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="container mx-auto px-6 py-4 flex items-center justify-between">
                <!-- ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ëŠ” ë§í¬ -->
                <a href="main.html" class="text-2xl font-bold text-gray-800 hover:text-blue-600 transition">ğŸ  ë„ë€ ({{ categoryTitle }})</a>
                <div v-if="loggedInUser" class="flex items-center space-x-3">
                    <span class="text-gray-600"><b>{{ loggedInUser }}</b>ë‹˜</span>
                    <button @click="logout" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded hover:bg-gray-300 transition">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-6 pb-12">
            <!-- ë¡œê·¸ì¸ ì•ˆ í•œ ê²½ìš° -->
            <div v-if="!loggedInUser" class="flex flex-col items-center justify-center py-20 text-center animate-fade-in-up">
                <div class="bg-white p-10 rounded-xl shadow-md max-w-lg w-full">
                    <div class="text-6xl mb-4">ğŸ”’</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</h2>
                    <a href="login.html" class="w-full inline-block bg-blue-600 text-white text-lg font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-lg">
                        ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°
                    </a>
                </div>
            </div>

            <!-- ë¡œê·¸ì¸ í•œ ê²½ìš°: ê²Œì‹œê¸€ ëª©ë¡ -->
            <div v-else class="bg-white rounded-lg shadow-md border border-gray-200 animate-fade-in-up">
                <div class="header flex flex-col md:flex-row justify-between items-center p-5 border-b border-gray-200 gap-4">
                    <h2 class="text-xl font-bold text-gray-700">{{ categoryTitle }}</h2>
                    <div class="flex items-center space-x-2 w-full md:w-auto">
                        <div class="relative flex-grow md:flex-grow-0">
                            <input v-model="searchKeyword" @keyup.enter="fetchPosts" type="text" placeholder="ì œëª© ê²€ìƒ‰..." class="w-full md:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                            <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
                        </div>
                        <button @click="fetchPosts" class="bg-gray-100 text-gray-600 font-semibold px-4 py-2 rounded-lg hover:bg-gray-200 transition border border-gray-300">ê²€ìƒ‰</button>
                        <button @click="openModal" class="bg-blue-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm whitespace-nowrap">+ ê¸€ì“°ê¸°</button>
                    </div>
                </div>
                
                <!-- í…Œì´ë¸” í˜•íƒœë¡œ ëª©ë¡ í‘œì‹œ -->
                <table class="w-full min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-left text-sm font-semibold text-gray-500 w-20">ë²ˆí˜¸</th>
                            <th class="p-4 text-left text-sm font-semibold text-gray-500">ì œëª©</th>
                            <th class="p-4 text-left text-sm font-semibold text-gray-500 w-32">ì‘ì„±ì</th>
                            <th class="p-4 text-left text-sm font-semibold text-gray-500 w-32">ì‘ì„±ì¼</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr v-if="posts.length === 0">
                            <td colspan="4" class="p-10 text-center text-gray-500">
                                <span v-if="searchKeyword">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                                <span v-else>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</span>
                            </td>
                        </tr>
                        <tr v-for="(post, index) in posts" :key="post.id" @click="goToDetail(post.id)" class="hover:bg-gray-50 cursor-pointer transition">
                            <td class="p-4 text-gray-600">{{ index + 1 }}</td>
                            <td class="p-4 font-medium text-gray-900 truncate">{{ post.title }}</td>
                            <td class="p-4 text-gray-600">{{ post.member ? post.member.username : 'ìµëª…' }}</td>
                            <td class="p-4 text-gray-500 text-sm">{{ formatDate(post.createdAt) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>

        <!-- ê¸€ ì‘ì„± ëª¨ë‹¬ (AI + ìµœì €ê°€ ê²€ìƒ‰) -->
        <post-modal v-if="isModalVisible" :board-title="categoryTitle" @close="closeModal" @save="savePost"></post-modal>
    </div>

    <script>
        // Vue ë¡œë“œ ì•ˆì „ì¥ì¹˜
        if (typeof Vue === 'undefined') {
            alert("Vue.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        } else {
            const { createApp } = Vue;

            // --- PostModal ì»´í¬ë„ŒíŠ¸ (AI + ìµœì €ê°€ ê²€ìƒ‰) ---
            const PostModal = {
                props: ['boardTitle'],
                emits: ['close', 'save'],
                data() { 
                    return { 
                        newPostTitle: '', 
                        newPostContent: '',
                        isLoadingAi: false,
                        aiUserPrompt: '',
                        showShoppingSearch: false,
                        shoppingQuery: '',
                        shoppingResults: [],
                        isLoadingShopping: false
                    }; 
                },
                computed: {
                    aiPlaceholder() {
                        if (this.boardTitle.includes('ê³µë™êµ¬ë§¤')) {
                            return "âœ¨ ê³µë™êµ¬ë§¤ ëª¨ì§‘í•  ë¬¼ê±´ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë‘ë£¨ë§ˆë¦¬ íœ´ì§€ 30ë¡¤). AIê°€ ìµœì €ê°€ì™€ ì‚¬ì´íŠ¸ë¥¼ ì¶”ì²œí•´ì¤ë‹ˆë‹¤!";
                        }
                        return "âœ¨ AIì—ê²Œ êµ¬ì²´ì ìœ¼ë¡œ ìš”ì²­í•˜ê¸° (ì˜ˆ: ìì·¨ìƒ ê°„ë‹¨ ìš”ë¦¬ ì¶”ì²œí•´ì¤˜)";
                    }
                },
                template: `
                    <div class="modal-overlay" @click.self="$emit('close')">
                        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 animate-fade-in-up flex flex-col max-h-[90vh]">
                            <div class="p-6 overflow-y-auto custom-scrollbar">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">{{ boardTitle }} <span class="text-sm font-normal text-gray-500">ê¸€ì“°ê¸°</span></h3>
                                
                                <input v-model="newPostTitle" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                                <textarea v-model="newPostContent" placeholder="ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”..." rows="6" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 transition"></textarea>
                                
                                <input v-model="aiUserPrompt" @keyup.enter="generateAiContent" type="text" 
                                       :placeholder="aiPlaceholder" 
                                       class="w-full p-3 border border-purple-300 rounded-lg mt-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
                                
                                <!-- ì‡¼í•‘ ê²€ìƒ‰ ì˜ì—­ (í† ê¸€) -->
                                <div v-if="showShoppingSearch" class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200 animate-fade-in-up">
                                    <h4 class="font-bold text-green-800 mb-2 text-sm">ğŸ›ï¸ ë„¤ì´ë²„ ìµœì €ê°€ ê²€ìƒ‰</h4>
                                    <div class="flex gap-2 mb-3">
                                        <input v-model="shoppingQuery" @keyup.enter="searchShopping" type="text" placeholder="ìƒí’ˆëª… ì…ë ¥ (ì˜ˆ: í–‡ë°˜)" class="flex-grow p-2 border rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500">
                                        <button @click="searchShopping" :disabled="isLoadingShopping" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 disabled:opacity-50">
                                            {{ isLoadingShopping ? 'ê²€ìƒ‰ì¤‘..' : 'ê²€ìƒ‰' }}
                                        </button>
                                    </div>
                                    <ul v-if="shoppingResults.length > 0" class="space-y-2 max-h-40 overflow-y-auto text-sm custom-scrollbar">
                                        <li v-for="item in shoppingResults" :key="item.productId" 
                                            @click="addShoppingItem(item)"
                                            class="flex items-center gap-2 p-2 bg-white rounded border hover:bg-green-100 cursor-pointer transition">
                                            <img :src="item.image" class="w-10 h-10 object-cover rounded">
                                            <div class="overflow-hidden">
                                                <div class="font-medium truncate" v-html="item.title"></div>
                                                <div class="text-red-500 font-bold">{{ Number(item.lprice).toLocaleString() }}ì›</div>
                                            </div>
                                        </li>
                                    </ul>
                                    <div v-else-if="!isLoadingShopping && shoppingQuery" class="text-center text-gray-500 text-xs mt-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 px-6 py-4 flex justify-between items-center rounded-b-lg">
                                <div class="flex gap-2">
                                    <button @click="generateAiContent" :disabled="isLoadingAi"
                                            class="flex items-center px-3 py-2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-lg hover:from-purple-600 hover:to-indigo-600 font-medium transition shadow-sm disabled:opacity-50 text-sm">
                                        âœ¨ AI {{ boardTitle.includes('ê³µë™êµ¬ë§¤') ? 'ëª¨ì§‘ê¸€ ìƒì„±' : 'ìƒì„±' }}
                                    </button>
                                    <button @click="showShoppingSearch = !showShoppingSearch" 
                                            class="flex items-center px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition shadow-sm text-sm">
                                        ğŸ” ìµœì €ê°€ ê²€ìƒ‰
                                    </button>
                                </div>
                                
                                <div class="flex space-x-2 items-center">
                                    <span v-if="isLoadingAi" class="text-xs text-gray-500 animate-pulse">AI ìƒì„± ì¤‘...</span>
                                    <button @click="$emit('close')" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition text-sm">ì·¨ì†Œ</button>
                                    <button @click="handleSave" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-sm transition text-sm">ë“±ë¡</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                methods: {
                    handleSave() {
                        if (!this.newPostTitle.trim() || !this.newPostContent.trim()) { alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                        this.$emit('save', this.newPostTitle, this.newPostContent);
                    },
                    async searchShopping() {
                        if (!this.shoppingQuery.trim()) return;
                        this.isLoadingShopping = true;
                        this.shoppingResults = [];
                        try {
                            const res = await axios.get(`http://localhost:8080/api/naver/search?query=${this.shoppingQuery}`);
                            this.shoppingResults = res.data.items;
                        } catch (e) {
                            // â˜… ìˆ˜ì •: ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ (object Object ë°©ì§€)
                            console.error("ì‡¼í•‘ ê²€ìƒ‰ ì—ëŸ¬:", e);
                            let msg = e.message;
                            if (e.response && e.response.data) {
                                if (typeof e.response.data === 'object') {
                                    // ê°ì²´ì¸ ê²½ìš° message ì†ì„± í™•ì¸, ì—†ìœ¼ë©´ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
                                    msg = e.response.data.message || JSON.stringify(e.response.data);
                                } else {
                                    msg = e.response.data;
                                }
                            }
                            alert("ê²€ìƒ‰ ì‹¤íŒ¨: " + msg);
                        } finally {
                            this.isLoadingShopping = false;
                        }
                    },
                    addShoppingItem(item) {
                        const title = item.title.replace(/<b>/g, '').replace(/<\/b>/g, '');
                        const textToAdd = `\n\nğŸ“¦ [ì‡¼í•‘ ì •ë³´]\nìƒí’ˆëª…: ${title}\nìµœì €ê°€: ${Number(item.lprice).toLocaleString()}ì›\nêµ¬ë§¤ì²˜: ${item.mallName}\në§í¬: ${item.link}`;
                        this.newPostContent += textToAdd;
                        this.showShoppingSearch = false;
                    },
                    getDefaultPrompt(boardTitle) {
                        if (boardTitle.includes('ê³µë™êµ¬ë§¤')) {
                            return "ê¸°ìˆ™ì‚¬ ê³µë™êµ¬ë§¤ ëª¨ì§‘ê¸€ì„ ì‘ì„±í•´ì¤˜. (ì œí’ˆ ì„¤ëª…, ëª¨ì§‘ ì¸ì›, 1/N ê°€ê²©, ì°¸ì—¬ ë°©ë²• ë“± í¬í•¨)";
                        }
                        if (boardTitle.includes('ë ˆì‹œí”¼')) return "ê°„ë‹¨í•œ ê¸°ìˆ™ì‚¬ ìš”ë¦¬ ë ˆì‹œí”¼ ì¶”ì²œí•´ì¤˜.";
                        if (boardTitle.includes('ê¿€íŒ')) return "ê¸°ìˆ™ì‚¬ ìƒí™œ ê¿€íŒ ì•Œë ¤ì¤˜.";
                        return "ê²Œì‹œê¸€ ë‚´ìš©ì„ ì‘ì„±í•´ì¤˜.";
                    },
                    async generateAiContent() {
                        this.isLoadingAi = true;
                        this.newPostContent = "AIê°€ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
                        
                        let prompt = this.aiUserPrompt;
                        if (!prompt) {
                            prompt = this.getDefaultPrompt(this.boardTitle);
                        } else if (this.boardTitle.includes('ê³µë™êµ¬ë§¤')) {
                            prompt = `"${prompt}"ì— ëŒ€í•œ ê³µë™êµ¬ë§¤ ëª¨ì§‘ê¸€ì„ ì¹œì ˆí•˜ê²Œ ì‘ì„±í•´ì¤˜.`;
                        }

                        try {
                            const res = await axios.post('http://localhost:8080/api/ai/generate', { prompt }, { timeout: 20000 });
                            this.newPostContent = res.data.text;
                            if(!this.newPostTitle.trim()) this.newPostTitle = res.data.text.split('\n')[0].substring(0, 30);
                            this.aiUserPrompt = '';
                        } catch (e) {
                            this.newPostContent = ""; alert("AI ìƒì„± ì‹¤íŒ¨: " + e.message);
                        } finally { this.isLoadingAi = false; }
                    }
                }
            };

            // --- 3. ë©”ì¸ Vue ì•± ---
            const app = createApp({
                data() {
                    return {
                        isModalVisible: false,
                        loggedInUser: localStorage.getItem('loggedInUser') || null,
                        posts: [],
                        category: null, 
                        categoryTitle: 'ê²Œì‹œíŒ',
                        searchKeyword: ''
                    }
                },
                mounted() {
                    const params = new URLSearchParams(window.location.search);
                    this.category = params.get('category'); 
                    this.setCategoryTitle();
                    if (this.loggedInUser) this.fetchPosts();
                },
                methods: {
                    setCategoryTitle() {
                        const titles = { group: 'ğŸ“¢ ê³µë™êµ¬ë§¤', review: 'â­ ì‚¬ìš© í›„ê¸°', recipe: 'ğŸ³ ê¸°ìˆ™ì‚¬ ë ˆì‹œí”¼', tip: 'ğŸ’¡ ìƒí™œ ê¿€íŒ', counseling: 'ğŸ’¬ ê³ ë¯¼ìƒë‹´ì†Œ' };
                        this.categoryTitle = titles[this.category] || 'ê²Œì‹œíŒ';
                    },
                    async fetchPosts() {
                        if (!this.category) return;
                        try {
                            let url = `http://localhost:8080/api/posts?category=${this.category}`;
                            if (this.searchKeyword.trim()) {
                                url += `&keyword=${encodeURIComponent(this.searchKeyword.trim())}`;
                            }
                            const response = await axios.get(url);
                            this.posts = response.data;
                        } catch (error) {
                            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                        }
                    },
                    logout() {
                        localStorage.removeItem('loggedInUser');
                        this.loggedInUser = null;
                        window.location.href = 'main.html'; 
                    },
                    async savePost(newTitle, newContent) {
                        try {
                            await axios.post('http://localhost:8080/api/posts', {
                                title: newTitle, content: newContent, category: this.category, username: this.loggedInUser
                            });
                            alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                            this.searchKeyword = ''; 
                            await this.fetchPosts();
                            this.closeModal();
                        } catch (e) { alert('ì €ì¥ ì‹¤íŒ¨'); }
                    },
                    goToDetail(postId) { window.location.href = `detail.html?id=${postId}`; },
                    openModal() { this.isModalVisible = true; },
                    closeModal() { this.isModalVisible = false; },
                    formatDate(dateString) {
                        if (!dateString) return '';
                        const date = new Date(dateString);
                        return `${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                    }
                } 
            }); 

            app.component('post-modal', PostModal);
            app.mount('#app');
        }
    </script>
</body>
</html>